<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>แดชบอร์ดสถิติเรื่องร้องเรียน</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Prompt', sans-serif;
      background-color: #fff1f2; /* red-tone iOS style */
      color: #991b1b;
    }
    canvas { max-width: 100%; height: auto; }
    .chart-title {
      font-weight: 600;
      color: #b91c1c;
      margin-top: 1rem;
      margin-bottom: 0.25rem;
      text-align: center;
    }
    h1 {
      color: #b91c1c;
    }
    .card {
      background-color: white;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      padding: 1rem;
    }
  </style>
</head>

  
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center my-6">
    <div class="bg-white rounded-xl p-4 shadow border border-red-200">
      <div class="text-sm text-gray-500">เรื่องร้องเรียนทั้งหมด</div>
      <div id="totalCount" class="text-2xl font-bold text-red-600">-</div>
    </div>
    <div class="bg-white rounded-xl p-4 shadow border border-green-200">
      <div class="text-sm text-gray-500">ดำเนินการแล้ว</div>
      <div id="completedCount" class="text-2xl font-bold text-green-600">-</div>
    </div>
    <div class="bg-white rounded-xl p-4 shadow border border-yellow-200">
      <div class="text-sm text-gray-500">อยู่ระหว่างดำเนินการ</div>
      <div id="pendingCount" class="text-2xl font-bold text-yellow-600">-</div>
    </div>
    <div class="bg-white rounded-xl p-4 shadow border border-blue-200">
      <div class="text-sm text-gray-500">อัตราความสำเร็จ</div>
      <div id="completionRate" class="text-2xl font-bold text-blue-600">-</div>
    </div>
  </div>
  <div class="text-center text-sm text-gray-600 mb-6">
    เปรียบเทียบแนวโน้ม: ระบบสามารถติดตามจำนวนเรื่องร้องเรียนที่เพิ่มขึ้นหรือลดลงรายเดือน พร้อมกราฟสถิติเพื่อช่วยการตัดสินใจเชิงบริหาร
  </div>
      <div id="totalCount" class="text-2xl font-bold text-red-600">-</div>
    </div>
    <div class="bg-white rounded-xl p-4 shadow border border-green-200">
      <div class="text-sm text-gray-500">ดำเนินการแล้ว</div>
      <div id="completedCount" class="text-2xl font-bold text-green-600">-</div>
    </div>
    <div class="bg-white rounded-xl p-4 shadow border border-yellow-200">
      <div class="text-sm text-gray-500">อยู่ระหว่างดำเนินการ</div>
      <div id="pendingCount" class="text-2xl font-bold text-yellow-600">-</div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="card">
      <div class="chart-title">จำนวนเรื่องตามสถานะ</div>
      <canvas id="barStatusChart"></canvas>
    </div>
    <div class="card">
      <div class="chart-title">สัดส่วนสถานะเรื่อง</div>
      <canvas id="pieStatusChart"></canvas>
    </div>
    <div class="card">
      <div class="chart-title">จำนวนเรื่องตามฝ่ายและสถานะ</div>
      <canvas id="stackedBarDepartment"></canvas>
    </div>
    <div class="card">
      <div class="chart-title">ระยะเวลาดำเนินการเฉลี่ยต่อฝ่าย</div>
      <canvas id="avgDaysDepartment"></canvas>
    </div>
    <div class="card">
      <div class="chart-title">จำนวนเรื่องตามผู้รับผิดชอบ</div>
      <canvas id="barResponsible"></canvas>
    </div>
    <div class="card">
      <div class="chart-title">แนวโน้มเรื่องร้องเรียนรายเดือน</div>
      <canvas id="barMonthTrend"></canvas>
    </div>
    <div class="card">
      <div class="chart-title">จำนวนเรื่องร้องเรียนตามพื้นที่</div>
      <canvas id="barDistrict"></canvas>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbz6qnkOu4F5vIHsj8lMhxlJpVGsVPg4Usb7GnnKf_JrxxIu0yYuIvim3N5TOh08g39n/exec?action=getStats';

    fetch(API_URL)
      .then(res => res.json())
      .then(res => {
        if (!res.success) throw new Error('โหลดข้อมูลไม่สำเร็จ');
        const data = res.data;
        document.getElementById('completionRate').textContent = data.completionRate + '%';

        // Update summary boxes
        document.getElementById('totalCount').textContent = data.all;
        document.getElementById('completedCount').textContent = data.completed;
        document.getElementById('pendingCount').textContent = data.pending;

        const ctx = id => document.getElementById(id);

        new Chart(ctx('barStatusChart'), {
          type: 'bar',
          data: {
            labels: ['ทั้งหมด', 'ดำเนินการแล้ว', 'อยู่ระหว่างดำเนินการ'],
            datasets: [{
              label: 'จำนวนเรื่อง',
              data: [data.all, data.completed, data.pending],
              backgroundColor: ['#1f77b4', '#2ca02c', '#d62728']
            }]
          }
        });

        new Chart(ctx('pieStatusChart'), {
          type: 'pie',
          data: {
            labels: ['ดำเนินการแล้ว', 'อยู่ระหว่างดำเนินการ'],
            datasets: [{
              data: [data.completed, data.pending],
              backgroundColor: ['#2ca02c', '#ff7f0e']
            }]
          }
        });

        const departments = Object.keys(data.byDepartment);
        const completedByDept = departments.map(d => data.byDepartment[d].completed);
        const pendingByDept = departments.map(d => data.byDepartment[d].pending);

        new Chart(ctx('stackedBarDepartment'), {
          type: 'bar',
          data: {
            labels: departments,
            datasets: [
              { label: 'ดำเนินการแล้ว', data: completedByDept, backgroundColor: '#2ca02c' },
              { label: 'อยู่ระหว่างดำเนินการ', data: pendingByDept, backgroundColor: '#ff7f0e' }
            ]
          },
          options: {
            responsive: true,
            plugins: { legend: { position: 'top' } },
            scales: { x: { stacked: true }, y: { stacked: true } }
          }
        });

        const avgDaysDept = departments.map(d => data.byDepartment[d].avgDays);
        new Chart(ctx('avgDaysDepartment'), {
          type: 'bar',
          data: {
            labels: departments,
            datasets: [{
              label: 'ระยะเวลาดำเนินการเฉลี่ย (วัน)',
              data: avgDaysDept,
              backgroundColor: '#9467bd'
            }]
          }
        });

        const persons = Object.keys(data.byResponsible);
        const doneByPerson = persons.map(p => data.byResponsible[p].completed);
        const pendingByPerson = persons.map(p => data.byResponsible[p].pending);
        new Chart(ctx('barResponsible'), {
          type: 'bar',
          data: {
            labels: persons,
            datasets: [
              { label: 'ดำเนินการแล้ว', data: doneByPerson, backgroundColor: '#17becf' },
              { label: 'อยู่ระหว่างดำเนินการ', data: pendingByPerson, backgroundColor: '#bcbd22' }
            ]
          },
          options: {
            plugins: { legend: { position: 'top' } },
            responsive: true
          }
        });

        const months = Object.keys(data.byMonth);
        const countsByMonth = months.map(m => data.byMonth[m]);
        new Chart(ctx('barMonthTrend'), {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: 'แนวโน้มรับเรื่องรายเดือน',
              data: countsByMonth,
              borderColor: '#d62728',
              fill: false
            }]
          },
          options: {
            responsive: true,
            tension: 0.3
          }
        });

        if (data.byDistrict) {
          const districts = Object.keys(data.byDistrict);
          const countsByDistrict = districts.map(d => {
            const val = data.byDistrict[d];
            return typeof val === 'number' ? val : (val.completed || 0) + (val.pending || 0);
          });
          new Chart(ctx('barDistrict'), {
            type: 'bar',
            data: {
              labels: districts,
              datasets: [{
                label: 'จำนวนเรื่องร้องเรียนรวม',
                data: countsByDistrict,
                backgroundColor: '#ff7f0e'
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { position: 'top' } }
            }
          });
        }
      })
      .catch(err => alert('เกิดข้อผิดพลาด: ' + err.message));
  </script>
</body>
</html>

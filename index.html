<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Prompt', sans-serif; background-color: #f9fafb; }
    canvas { max-width: 100%; height: auto; }
  </style>
</head>
<body class="p-6">
  <h1 class="text-2xl font-bold mb-4 text-center text-blue-700">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
  
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <canvas id="barStatusChart"></canvas>
    <canvas id="pieStatusChart"></canvas>
    <canvas id="stackedBarDepartment"></canvas>
    <canvas id="avgDaysDepartment"></canvas>
    <canvas id="barDetails"></canvas>
    <canvas id="lineDetailsAvg"></canvas>
    <canvas id="barResponsible"></canvas>
    <canvas id="barMonthTrend"></canvas>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbz6qnkOu4F5vIHsj8lMhxlJpVGsVPg4Usb7GnnKf_JrxxIu0yYuIvim3N5TOh08g39n/exec?action=getStats';

    fetch(API_URL)
      .then(res => res.json())
      .then(res => {
        if (!res.success) throw new Error('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        const data = res.data;

        const ctx = id => document.getElementById(id);

        // 1. Bar Chart - Status
        new Chart(ctx('barStatusChart'), {
          type: 'bar',
          data: {
            labels: ['‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß', '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'],
            datasets: [{
              label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á',
              data: [data.all, data.completed, data.pending],
              backgroundColor: ['#60a5fa', '#34d399', '#fbbf24']
            }]
          }
        });

        // 2. Pie Chart - Completion Rate
        new Chart(ctx('pieStatusChart'), {
          type: 'pie',
          data: {
            labels: ['‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß', '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'],
            datasets: [{
              data: [data.completed, data.pending],
              backgroundColor: ['#10b981', '#f59e0b']
            }]
          }
        });

        // 3. Stacked Bar - Department by status
        const departments = Object.keys(data.byDepartment);
        const completedByDept = departments.map(d => data.byDepartment[d].completed);
        const pendingByDept = departments.map(d => data.byDepartment[d].pending);

        new Chart(ctx('stackedBarDepartment'), {
          type: 'bar',
          data: {
            labels: departments,
            datasets: [
              { label: '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß', data: completedByDept, backgroundColor: '#22c55e' },
              { label: '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', data: pendingByDept, backgroundColor: '#f97316' }
            ]
          },
          options: {
            responsive: true,
            plugins: { legend: { position: 'top' } },
            scales: { x: { stacked: true }, y: { stacked: true } }
          }
        });

        // 4. Bar - Average days by Department
        const avgDaysDept = departments.map(d => data.byDepartment[d].avgDays);
        new Chart(ctx('avgDaysDepartment'), {
          type: 'bar',
          data: {
            labels: departments,
            datasets: [{
              label: '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ß‡∏±‡∏ô)',
              data: avgDaysDept,
              backgroundColor: '#6366f1'
            }]
          }
        });

        // 5. Bar - Count by Details
        const details = Object.keys(data.byDetails);
        const countsByDetail = details.map(d => data.byDetails[d].all);
        new Chart(ctx('barDetails'), {
          type: 'bar',
          data: {
            labels: details,
            datasets: [{
              label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó',
              data: countsByDetail,
              backgroundColor: '#ec4899'
            }]
          },
          options: { indexAxis: 'y' }
        });

        // 6. Line - Average days by Detail
        const avgDaysDetail = details.map(d => data.byDetails[d].avgDays);
        new Chart(ctx('lineDetailsAvg'), {
          type: 'line',
          data: {
            labels: details,
            datasets: [{
              label: '‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏ß‡∏±‡∏ô)',
              data: avgDaysDetail,
              borderColor: '#0ea5e9',
              tension: 0.3
            }]
          }
        });

        // 7. Bar - By Responsible
        const persons = Object.keys(data.byResponsible);
        const doneByPerson = persons.map(p => data.byResponsible[p].completed);
        const pendingByPerson = persons.map(p => data.byResponsible[p].pending);
        new Chart(ctx('barResponsible'), {
          type: 'bar',
          data: {
            labels: persons,
            datasets: [
              { label: '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß', data: doneByPerson, backgroundColor: '#4ade80' },
              { label: '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', data: pendingByPerson, backgroundColor: '#facc15' }
            ]
          },
          options: {
            plugins: { legend: { position: 'top' } },
            responsive: true
          }
        });

        // 8. Line - Monthly trend
        const months = Object.keys(data.byMonth);
        const countsByMonth = months.map(m => data.byMonth[m]);
        new Chart(ctx('barMonthTrend'), {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: '‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
              data: countsByMonth,
              borderColor: '#ef4444',
              fill: false
            }]
          },
          options: {
            responsive: true,
            tension: 0.3
          }
        });
      })
      .catch(err => alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message));
  </script>
</body>
</html>
